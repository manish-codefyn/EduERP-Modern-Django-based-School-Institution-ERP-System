{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}Inventory Dashboard - {{ organization.name|default:"Codefyn" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css">

{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- Header -->
    <div class="header-section mb-4">
        <div class="row align-items-center">
            <div class="col-md-6 d-flex align-items-center">
                <div class="header-icon me-3">
                    <i class="bi bi-box-seam display-6 text-primary"></i>
                </div>
                <div>
                    <h1 class="h3 fw-bold mb-1">Inventory Management</h1>
                    <p class="text-custom mb-0">Monitor and manage your institution's inventory</p>
                </div>
            </div>
            <div class="col-md-6">
                {% if request.user.is_superadmin or request.user.is_institution_admin %}
                <div class="d-flex justify-content-end align-items-center gap-2">
                    <a href="{% url 'inventory:item_create' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i> New Item
                    </a>
                    <a href="{% url 'inventory:transaction_create' %}" class="btn btn-success">
                        <i class="bi bi-arrow-left-right me-1"></i> Stock Transaction
                    </a>
                    <!-- <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="exportDropdown"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-download me-1"></i> Export
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="exportDropdown">
                            <li class="dropdown-header">Export Inventory Data</li>
                            <li><a class="dropdown-item" href="{% url 'inventory:export' %}?format=csv">
                                <i class="bi bi-filetype-csv me-2"></i> Export CSV</a></li>
                            <li><a class="dropdown-item" href="{% url 'inventory:export' %}?format=excel">
                                <i class="bi bi-file-earmark-excel me-2"></i> Export Excel</a></li>
                            <li><a class="dropdown-item" href="{% url 'inventory:export' %}?format=pdf">
                                <i class="bi bi-file-earmark-pdf me-2"></i> Export PDF</a></li>
                        </ul>
                    </div> -->
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card text-white h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body">
                    <h6 class="card-title mb-1 small opacity-75">TOTAL ITEMS</h6>
                    <h3 class="mb-0 fw-bold">{{ total_items }}</h3>
                    <p class="mb-0 small opacity-75"><i class="bi bi-box me-1"></i>All inventory items</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card text-white h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="card-body">
                    <h6 class="card-title mb-1 small opacity-75">TOTAL VALUE</h6>
                    <h3 class="mb-0 fw-bold">${{ total_value|default:"0"|floatformat:2 }}</h3>
                    <p class="mb-0 small opacity-75"><i class="bi bi-currency-dollar me-1"></i>Total inventory value</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card text-white h-100" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="card-body">
                    <h6 class="card-title mb-1 small opacity-75">IN STOCK</h6>
                    <h3 class="mb-0 fw-bold">{{ in_stock_count }}</h3>
                    <p class="mb-0 small opacity-75"><i class="bi bi-check-circle me-1"></i>Adequate stock items</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card text-white h-100" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="card-body">
                    <h6 class="card-title mb-1 small opacity-75">CATEGORIES</h6>
                    <h3 class="mb-0 fw-bold">{{ total_categories }}</h3>
                    <p class="mb-0 small opacity-75"><i class="bi bi-tags me-1"></i>Active categories</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl-4 col-md-6">
            <div class="card border-warning h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-warning mb-1">LOW STOCK</h6>
                            <h3 class="mb-0 fw-bold text-warning">{{ low_stock_count }}</h3>
                            <p class="mb-0 small text-custom">Items need replenishment</p>
                        </div>
                        <i class="bi bi-exclamation-triangle display-6 text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6">
            <div class="card border-danger h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-danger mb-1">OUT OF STOCK</h6>
                            <h3 class="mb-0 fw-bold text-danger">{{ out_of_stock_count }}</h3>
                            <p class="mb-0 small text-custom">Items need immediate attention</p>
                        </div>
                        <i class="bi bi-x-circle display-6 text-danger"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6">
            <div class="card border-info h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-info mb-1">PURCHASE ORDERS</h6>
                            <h3 class="mb-0 fw-bold text-info">{{ total_orders }}</h3>
                            <p class="mb-0 small text-custom">{{ pending_orders }} pending orders</p>
                        </div>
                        <i class="bi bi-cart-check display-6 text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Low Stock Items -->
        <div class="col-xl-6">
            <div class="card card-custom h-100">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0 fw-bold text-custom">Low Stock Alert</h5>
                    <p class="text-custom mb-0">Items that need replenishment</p>
                </div>
                <div class="card-body">
                    {% if low_stock_items %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Current Stock</th>
                                    <th>Min Quantity</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in low_stock_items %}
                                <tr>
                                    <td>{{ item.name }}</td>
                                    <td>{{ item.quantity }} {{ item.unit }}</td>
                                    <td>{{ item.min_quantity }} {{ item.unit }}</td>
                                    <td>
                                        <span class="badge {% if item.status == 'low_stock' %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ item.status|title }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-check-circle display-4 text-success"></i>
                        <p class="mt-3 mb-0 text-custom">All items are adequately stocked!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="col-xl-6">
            <div class="card card-custom h-100">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0 fw-bold text-custom">Recent Transactions</h5>
                    <p class="text-custom mb-0">Latest stock movements</p>
                </div>
                <div class="card-body">
                    {% if recent_transactions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in recent_transactions %}
                                <tr>
                                    <td>{{ transaction.item.name }}</td>
                                    <td>
                                        <span class="badge {% if transaction.transaction_type == 'purchase' %}bg-success{% elif transaction.transaction_type == 'issue' %}bg-primary{% else %}bg-info{% endif %}">
                                            {{ transaction.get_transaction_type_display }}
                                        </span>
                                    </td>
                                    <td>{{ transaction.quantity }}</td>
                                    <td>{{ transaction.transaction_date|date:"M d, Y" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-clock-history display-4 text-secondary"></i>
                        <p class="mt-3 mb-0 text-custom">No recent transactions</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTables
    $('table').DataTable({
        "pageLength": 5,
        "searching": false,
        "lengthChange": false,
        "language": {
            "info": "Showing _START_ to _END_ of _TOTAL_ entries",
        }
    });

    // Initialize Select2
    $('select').select2({ theme: 'bootstrap-5', width: '100%' });
});
</script>
{% endblock %}