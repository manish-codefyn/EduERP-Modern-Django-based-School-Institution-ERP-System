{% extends 'hr/base.html' %}
{% load static %}

{% block title %}Mark Attendance - {{ organization.name|default:"ERP System" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
:root {
    --primary: #4361ee;
    --primary-dark: #3a56d4;
    --secondary: #7209b7;
    --success: #4cc9f0;
    --danger: #f72585;
    --warning: #f8961e;
    --info: #4895ef;
    --light: #f8f9fa;
    --dark: #212529;
    --gray: #6c757d;
    --border-radius: 12px;
    --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    --transition: all 0.3s ease;
}

.attendance-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.staff-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    overflow: hidden;
    transition: var(--transition);
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.staff-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.staff-header {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 1.5rem;
    text-align: center;
    position: relative;
}

.staff-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid rgba(255, 255, 255, 0.3);
    margin: 0 auto 1rem;
    overflow: hidden;
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: white;
    font-weight: 600;
}

.staff-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.staff-name {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.staff-id {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
}

.staff-department {
    font-size: 0.85rem;
    opacity: 0.8;
}

.staff-details {
    padding: 1.25rem;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.detail-label {
    font-weight: 500;
    color: var(--gray);
    font-size: 0.9rem;
}

.detail-value {
    font-weight: 600;
    font-size: 0.9rem;
}

.attendance-actions {
    padding: 1.25rem;
    background-color: #f9fafb;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
}

.attendance-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
}

.btn-attendance {
    padding: 0.75rem 0.5rem;
    border: 2px solid transparent;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    font-size: 0.85rem;
    text-align: center;
}

.btn-present {
    background-color: #e8f5e8;
    color: #2e7d32;
    border-color: #e8f5e8;
}

.btn-present:hover, .btn-present.active {
    background-color: #2e7d32;
    color: white;
    border-color: #2e7d32;
}

.btn-absent {
    background-color: #ffebee;
    color: #c62828;
    border-color: #ffebee;
}

.btn-absent:hover, .btn-absent.active {
    background-color: #c62828;
    color: white;
    border-color: #c62828;
}

.btn-half-day {
    background-color: #fff3e0;
    color: #ef6c00;
    border-color: #fff3e0;
}

.btn-half-day:hover, .btn-half-day.active {
    background-color: #ef6c00;
    color: white;
    border-color: #ef6c00;
}

.btn-leave {
    background-color: #e3f2fd;
    color: #1565c0;
    border-color: #e3f2fd;
}

.btn-leave:hover, .btn-leave.active {
    background-color: #1565c0;
    color: white;
    border-color: #1565c0;
}

.bulk-submit-section {
    margin-top: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    text-align: center;
    position: sticky;
    bottom: 20px;
    z-index: 100;
}

.btn-submit-bulk {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border: none;
    padding: 1rem 2.5rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
}

.btn-submit-bulk:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
}

.stats-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: var(--border-radius);
}

.stats-item {
    text-align: center;
}

.stats-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.stats-label {
    font-size: 0.85rem;
    opacity: 0.9;
}

@media (max-width: 768px) {
    .attendance-grid {
        grid-template-columns: 1fr;
    }
    
    .attendance-buttons {
        grid-template-columns: 1fr;
    }
    
    .stats-bar {
        flex-direction: column;
        gap: 1rem;
    }
}

.attendance-status-indicator {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
}

.status-pending {
    background-color: #ffc107;
}

.status-marked {
    background-color: #28a745;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">Mark Attendance</h2>
            <p class="text-muted mb-0">Manage staff attendance for selected date</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'hr:attendance_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to List
            </a>
        </div>
    </div>

    <!-- Date and Filters -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Date</label>
                    <input type="date" name="date" class="form-control form-control-lg" value="{{ selected_date }}">
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Department</label>
                    <select name="department_id" class="form-select form-select-lg">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}" {% if selected_department_id == dept.id|stringformat:"s" %}selected{% endif %}>
                            {{ dept.name }} ({{ dept.staff_count }} staff)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="bi bi-filter me-2"></i> Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics Bar -->
    <div class="stats-bar">
        <div class="stats-item">
            <div class="stats-value">{{ staff_count }}</div>
            <div class="stats-label">Total Staff</div>
        </div>
        <div class="stats-item">
            <div class="stats-value" id="present-count">0</div>
            <div class="stats-label">Present</div>
        </div>
        <div class="stats-item">
            <div class="stats-value" id="absent-count">0</div>
            <div class="stats-label">Absent</div>
        </div>
        <div class="stats-item">
            <div class="stats-value" id="halfday-count">0</div>
            <div class="stats-label">Half Day</div>
        </div>
        <div class="stats-item">
            <div class="stats-value" id="leave-count">0</div>
            <div class="stats-label">On Leave</div>
        </div>
    </div>

    <!-- Attendance Grid -->
    <form method="post" id="bulkAttendanceForm">
        {% csrf_token %}
        <input type="hidden" name="attendance_date" value="{{ selected_date }}">
        <input type="hidden" name="bulk_submit" value="true">
        
        <div class="attendance-grid">
            {% for staff in filtered_staff_list %}
            <div class="staff-card" data-staff-id="{{ staff.id }}">
                <div class="staff-header">
                    <div class="attendance-status-indicator status-pending" id="indicator-{{ staff.id }}"></div>
                    <div class="staff-avatar">
                        {% if staff.photo %}
                            <img src="{{ staff.photo.url }}" alt="{{ staff.user.get_full_name }}">
                        {% else %}
                            {{ staff.user.get_full_name|slice:":2"|upper }}
                        {% endif %}
                    </div>
                    <div class="staff-name">{{ staff.user.get_full_name }}</div>
                    <div class="staff-id">{{ staff.employee_id }}</div>
                    <div class="staff-department">{{ staff.department.name }}</div>
                </div>
                
                <div class="staff-details">
                    <div class="detail-item">
                        <span class="detail-label">Designation:</span>
                        <span class="detail-value">{{ staff.designation.name }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Type:</span>
                        <span class="detail-value">{{ staff.get_staff_type_display }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">
                            {% if staff.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="attendance-actions">
                    <div class="attendance-buttons">
                        <input type="radio" class="btn-check" name="staff_{{ staff.id }}" id="present_{{ staff.id }}" value="present" autocomplete="off">
                        <label class="btn btn-attendance btn-present" for="present_{{ staff.id }}">
                            <i class="bi bi-check-circle"></i> Present
                        </label>

                        <input type="radio" class="btn-check" name="staff_{{ staff.id }}" id="absent_{{ staff.id }}" value="absent" autocomplete="off">
                        <label class="btn btn-attendance btn-absent" for="absent_{{ staff.id }}">
                            <i class="bi bi-x-circle"></i> Absent
                        </label>

                        <input type="radio" class="btn-check" name="staff_{{ staff.id }}" id="half_day_{{ staff.id }}" value="half_day" autocomplete="off">
                        <label class="btn btn-attendance btn-half-day" for="half_day_{{ staff.id }}">
                            <i class="bi bi-clock-half"></i> Half Day
                        </label>

                        <input type="radio" class="btn-check" name="staff_{{ staff.id }}" id="leave_{{ staff.id }}" value="leave" autocomplete="off">
                        <label class="btn btn-attendance btn-leave" for="leave_{{ staff.id }}">
                            <i class="bi bi-calendar-x"></i> Leave
                        </label>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center py-5">
                <i class="bi bi-people display-4 text-muted d-block mb-3"></i>
                <h4 class="text-muted">No staff members found</h4>
                <p class="text-muted">Try adjusting your filters or add staff members to the system.</p>
            </div>
            {% endfor %}
        </div>

        {% if filtered_staff_list %}
        <div class="bulk-submit-section">
            <button type="submit" class="btn-submit-bulk" id="submitBulkAttendance">
                <i class="bi bi-cloud-arrow-up me-2"></i> 
                Submit Attendance for <span id="selected-count">0</span> out of {{ filtered_staff_list|length }} Employees
            </button>
        </div>
        {% endif %}
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize counters
    let counters = {
        present: 0,
        absent: 0,
        half_day: 0,
        leave: 0,
        totalSelected: 0
    };

    // Update counters display
    function updateCounters() {
        document.getElementById('present-count').textContent = counters.present;
        document.getElementById('absent-count').textContent = counters.absent;
        document.getElementById('halfday-count').textContent = counters.half_day;
        document.getElementById('leave-count').textContent = counters.leave;
        document.getElementById('selected-count').textContent = counters.totalSelected;
    }

    // Add event listeners to attendance buttons
    document.querySelectorAll('.btn-check').forEach(radio => {
        radio.addEventListener('change', function() {
            const label = document.querySelector(`label[for="${this.id}"]`);
            const staffCard = this.closest('.staff-card');
            const staffId = staffCard.dataset.staffId;
            const status = this.value;
            
            // Remove active class from all buttons in this group
            staffCard.querySelectorAll('.btn-attendance').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to selected button
            if (this.checked) {
                label.classList.add('active');
                
                // Update indicator
                const indicator = document.getElementById(`indicator-${staffId}`);
                indicator.classList.remove('status-pending');
                indicator.classList.add('status-marked');
                
                // Update counters
                counters.totalSelected++;
                counters[status]++;
            }
            
            updateCounters();
        });
    });

    // Form submission handling
    document.getElementById('bulkAttendanceForm').addEventListener('submit', function(e) {
        const selectedCount = document.querySelectorAll('input[type="radio"]:checked').length;
        if (selectedCount === 0) {
            e.preventDefault();
            alert('Please mark attendance for at least one employee.');
            return false;
        }
        
        if (!confirm(`Are you sure you want to submit attendance for ${selectedCount} employees?`)) {
            e.preventDefault();
            return false;
        }
        
        // Show loading state
        const submitBtn = document.getElementById('submitBulkAttendance');
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i> Submitting...';
        submitBtn.disabled = true;
    });

    // Initialize counters
    updateCounters();
});
</script>
{% endblock %}